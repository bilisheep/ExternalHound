# ExternalHound 功能需求文档 v1.0

**文档信息**
- 版本：v1.0
- 日期：2026-01-16
- 系统定位：渗透测试数据管理与可视化平台（仅管理与展示，不执行扫描）
- 状态：正式版

---

## 1. 项目概述

### 1.1 项目背景

ExternalHound 是一个专为渗透测试团队设计的**数据管理和可视化平台**。它不执行任何主动扫描或攻击，而是专注于：
- 接收和解析外部扫描工具的结果
- 构建资产关系图谱
- 提供强大的查询和可视化能力
- 生成专业的分析报告

### 1.2 核心价值

- **统一数据管理**：整合多种扫描工具的结果，建立统一的资产视图
- **关系可视化**：基于图数据库构建资产间的复杂关系，直观展示攻击面
- **高效查询**：支持多维度查询和过滤，快速定位目标资产
- **数据追溯**：保留完整的数据来源和历史记录，支持审计和复盘

### 1.3 系统边界

**范围内**
- ✅ 数据导入（多种格式）
- ✅ 数据存储（PG + Neo4j）
- ✅ 数据查询（多维度、模糊搜索）
- ✅ 图谱可视化（关系、路径）
- ✅ 报表导出（CSV、JSON、PDF）

**范围外**
- ❌ 主动扫描（端口扫描、漏洞扫描等）
- ❌ 任务调度和编排
- ❌ 复杂的权限和用户管理（暂不考虑）
- ❌ 审批流程和工作流
- ❌ 实时监控和告警

---

## 2. 核心功能模块

### 2.1 数据导入

**优先级**：P0

**功能描述**

支持多种扫描工具的结果导入，包括但不限于：
- Nmap XML
- Masscan JSON
- Nuclei JSON
- 通用 JSON/CSV/XML

**详细功能**

1. **文件上传**
   - 支持单文件和批量上传
   - 支持拖拽上传
   - 文件大小限制（可配置，默认 100MB）
   - 支持的格式自动识别

2. **URL 导入**
   - 支持从 URL 下载文件
   - 支持 HTTP/HTTPS
   - 支持认证（Basic Auth、Token）

3. **Schema 校验**
   - 自动识别文件格式
   - 验证必填字段
   - 数据类型检查
   - 格式错误提示

4. **字段映射**
   - 支持自定义字段映射
   - 预设常用工具的映射模板
   - 映射模板可保存和复用

5. **批量导入**
   - 支持批量上传多个文件
   - 显示导入进度
   - 支持暂停和恢复
   - 失败自动重试

6. **导入历史**
   - 记录所有导入操作
   - 显示导入状态（成功、失败、部分成功）
   - 记录导入的文件信息
   - 记录解析的资产数量
   - 错误日志详情

7. **原始文件存档**
   - 所有导入的原始文件保存到 MinIO
   - 支持下载原始文件
   - 支持重新解析

**关键用例**

1. **导入 Nmap 扫描结果**
   - 用户上传 Nmap XML 文件
   - 系统自动识别格式
   - 解析出 IP、端口、服务、指纹等信息
   - 写入数据库并建立关系
   - 显示导入成功的资产数量

2. **批量导入多个扫描结果**
   - 用户选择多个文件（Nmap、Masscan、Nuclei）
   - 系统依次解析每个文件
   - 显示整体进度和每个文件的状态
   - 汇总导入结果

3. **查看导入历史和错误**
   - 用户查看导入历史列表
   - 点击某次导入查看详情
   - 查看解析错误的记录
   - 下载原始文件重新处理

**数据流**

```
用户上传文件
    ↓
格式识别与校验
    ↓
解析数据（调用对应的 Parser）
    ↓
数据归一化（转换为标准模型）
    ↓
去重与合并
    ↓
写入 PostgreSQL
    ↓
批量写入 Neo4j
    ↓
保存原始文件到 MinIO
    ↓
记录导入日志
    ↓
返回导入结果
```

**验收标准**

- 支持至少 3 种主流扫描工具格式（Nmap、Masscan、Nuclei）
- 导入成功率 > 95%
- 单文件导入时间 < 30s（1000 条记录）
- 错误信息清晰明确
- 原始文件可追溯

---

### 2.2 数据管理

**优先级**：P0

**功能描述**

提供完整的资产数据管理能力，包括增删改查、去重合并、关系维护等。

**详细功能**

1. **资产 CRUD**
   - 创建资产（手动添加）
   - 查看资产详情
   - 编辑资产信息
   - 删除资产（软删除）
   - 批量操作

2. **去重与合并**
   - 自动识别重复资产
   - 按规则自动合并
   - 手动合并资产
   - 合并历史记录
   - 拆分错误合并的资产

3. **数据归一化**
   - 统一数据格式
   - 标准化字段名称
   - 数据类型转换
   - 缺失值处理

4. **关系管理**
   - 自动建立资产关系
   - 手动添加关系
   - 编辑关系属性
   - 删除关系
   - 关系验证

5. **标签管理**
   - 添加自定义标签
   - 标签分类
   - 批量打标签
   - 按标签筛选

6. **备注与注释**
   - 为资产添加备注
   - 支持 Markdown 格式
   - 备注历史记录

**关键用例**

1. **合并重复的 IP 资产**
   - 系统检测到同一 IP 被多次导入
   - 显示重复资产列表
   - 用户选择合并策略（保留最新、保留高置信度等）
   - 系统自动合并属性和关系
   - 记录合并历史

2. **手动添加资产**
   - 用户点击"添加资产"
   - 选择资产类型（IP、域名、服务等）
   - 填写必填字段
   - 系统验证数据
   - 保存到数据库并建立关系

3. **批量打标签**
   - 用户筛选出一批资产
   - 选择"批量操作" → "添加标签"
   - 输入标签名称
   - 系统为所有选中资产添加标签

**数据模型**

基于技术架构文档中定义的 8 类节点：
- Organization（组织）
- Netblock（网段）
- Domain（域名）
- IP（主机）
- Certificate（证书）
- Service（服务）
- ClientApplication（客户端应用）
- Credential（凭证）

**验收标准**

- 支持所有 8 类资产的 CRUD 操作
- 去重准确率 > 90%
- 合并操作可撤销
- 关系建立准确无误
- 操作响应时间 < 1s

---

### 2.3 数据查询

**优先级**：P0

**功能描述**

提供强大的多维度查询能力，支持基础查询、模糊搜索、高级过滤和关系查询。

**详细功能**

1. **基础查询**
   - 按 IP 地址查询
   - 按域名查询
   - 按端口查询
   - 按服务类型查询
   - 按组织查询

2. **模糊搜索**
   - 全文搜索（标题、Banner、描述）
   - 域名模糊匹配
   - 证书 SAN 搜索
   - 支持通配符（*、?）
   - 支持正则表达式

3. **高级过滤**
   - 多条件组合（AND、OR、NOT）
   - 时间范围过滤
   - 来源过滤
   - 标签过滤
   - 自定义字段过滤

4. **关系查询**
   - 查询资产的邻居节点
   - 查询两个资产之间的路径
   - 查询某类关系的所有资产
   - 多跳查询（1-N 跳）

5. **保存查询**
   - 保存常用查询条件
   - 查询模板管理
   - 快速应用查询模板

6. **查询历史**
   - 记录查询历史
   - 快速重复查询
   - 查询统计

**关键用例**

1. **查询开放 443 端口且证书即将过期的服务**
   ```
   条件1：Service.port = 443
   条件2：Service.is_http = true
   条件3：Certificate.days_to_expire < 30
   关系：Service -[HAS_CERTIFICATE]-> Certificate
   ```

2. **查询某域名的所有子域名**
   ```
   条件：Domain.root_domain = "target.com"
   排序：按层级排序
   ```

3. **查询某 IP 的上下游关系**
   ```
   查询：IP(1.2.3.4) 的所有邻居节点
   深度：2 跳
   方向：双向
   ```

4. **模糊搜索包含 "admin" 的域名**
   ```
   字段：Domain.name
   模式：*admin*
   ```

**查询性能优化**

- PostgreSQL 索引优化
  - IP 地址索引
  - 域名索引
  - 端口索引
  - JSONB GIN 索引（全文搜索）
  - 时间戳索引

- Neo4j 索引优化
  - 节点 ID 唯一约束
  - 常用属性索引
  - 关系类型索引

- 缓存策略
  - 热点查询结果缓存（Redis）
  - 缓存过期时间：5 分钟
  - 缓存失效策略：数据更新时清除

**验收标准**

- 基础查询响应时间 < 500ms
- 模糊搜索响应时间 < 1s
- 关系查询（2 跳）响应时间 < 2s
- 支持至少 10 个条件的组合查询
- 查询结果准确率 100%

---

### 2.4 图谱可视化

**优先级**：P0

**功能描述**

基于 Neo4j 的关系数据，提供交互式的资产关系图谱可视化。

**详细功能**

1. **图谱展示**
   - 节点展示（不同类型不同颜色和形状）
   - 边展示（不同关系类型不同样式）
   - 节点标签（显示关键信息）
   - 节点大小（根据重要性调整）

2. **交互操作**
   - 拖拽节点
   - 缩放画布
   - 平移画布
   - 点击节点查看详情
   - 双击节点展开邻居
   - 右键菜单（展开、隐藏、固定等）

3. **布局算法**
   - 力导向布局（Force-directed）
   - 层次布局（Hierarchical）
   - 圆形布局（Circular）
   - 网格布局（Grid）
   - 自定义布局

4. **筛选与过滤**
   - 按节点类型筛选
   - 按关系类型筛选
   - 按属性过滤
   - 隐藏/显示节点
   - 高亮特定节点

5. **路径分析**
   - 查找两个节点之间的最短路径
   - 查找所有路径
   - 路径高亮显示
   - 路径详情展示

6. **图谱导出**
   - 导出为 PNG 图片
   - 导出为 SVG 矢量图
   - 导出为 JSON 数据
   - 导出为 Cypher 查询语句

7. **图谱配置**
   - 节点样式配置
   - 边样式配置
   - 布局参数配置
   - 显示/隐藏标签
   - 性能优化配置

**关键用例**

1. **查看某组织的资产全景图**
   - 用户选择一个组织
   - 系统查询该组织的所有资产和关系
   - 以力导向布局展示图谱
   - 用户可以拖拽和缩放查看

2. **分析某证书关联的域名和服务**
   - 用户点击一个证书节点
   - 系统展开该证书的所有关系
   - 显示关联的域名和服务
   - 高亮显示关键路径

3. **查找从外网到内网的攻击路径**
   - 用户选择一个外网 IP
   - 选择一个内网服务
   - 系统查找所有可能的路径
   - 高亮显示最短路径
   - 显示路径详情（经过的节点和关系）

**图谱性能优化**

- 节点数量限制
  - 默认显示 500 个节点
  - 超过限制时提示用户筛选
  - 支持分页加载

- 渲染优化
  - 使用 Canvas 渲染（性能优于 SVG）
  - 节点聚合（相似节点合并显示）
  - 延迟加载（按需加载邻居节点）

- 交互优化
  - 防抖和节流
  - 虚拟滚动
  - 增量渲染

**验收标准**

- 支持至少 1000 个节点的流畅展示
- 交互响应时间 < 100ms
- 路径查询准确率 100%
- 图谱导出功能完整
- 支持至少 4 种布局算法

---

### 2.5 报表与导出

**优先级**：P1

**功能描述**

提供数据统计、报表生成和多格式导出功能。

**详细功能**

1. **数据统计**
   - 资产总数统计
   - 按类型统计
   - 按来源统计
   - 按时间统计
   - 趋势分析

2. **报表生成**
   - 资产清单报表
   - 高风险资产报表
   - 证书过期报表
   - 自定义报表模板

3. **数据导出**
   - 导出为 CSV
   - 导出为 JSON
   - 导出为 Excel
   - 导出为 PDF（报表）

4. **导出配置**
   - 选择导出字段
   - 选择导出格式
   - 设置导出范围
   - 导出历史记录

**关键用例**

1. **导出高风险服务列表**
   - 用户筛选出高风险服务
   - 选择"导出" → "CSV"
   - 选择导出字段（IP、端口、服务、风险等级）
   - 下载 CSV 文件

2. **生成资产清单报表**
   - 用户选择"报表" → "资产清单"
   - 选择时间范围
   - 选择资产类型
   - 生成 PDF 报表
   - 下载或打印

3. **导出图谱数据**
   - 用户在图谱页面选择"导出"
   - 选择"JSON 格式"
   - 系统导出节点和边数据
   - 可用于其他工具分析

**验收标准**

- 支持至少 3 种导出格式（CSV、JSON、PDF）
- 导出速度 < 10s（1000 条记录）
- 导出数据完整准确
- 报表格式专业美观

---

### 2.6 基础配置

**优先级**：P1

**功能描述**

提供系统基础配置和管理功能。

**详细功能**

1. **系统配置**
   - 分页大小配置
   - 文件上传限制
   - 缓存配置
   - 日志级别配置

2. **数据源配置**
   - 字段映射模板管理
   - 解析器配置
   - 去重规则配置
   - 合并策略配置

3. **显示配置**
   - 列表显示字段
   - 图谱样式配置
   - 主题配置
   - 语言配置

4. **操作日志**
   - 记录所有操作
   - 日志查询
   - 日志导出

**关键用例**

1. **配置 Nmap 字段映射模板**
   - 用户进入"配置" → "数据源"
   - 选择"Nmap XML"
   - 配置字段映射关系
   - 保存模板
   - 下次导入自动应用

2. **查看操作日志**
   - 用户进入"日志"页面
   - 筛选时间范围和操作类型
   - 查看详细日志
   - 导出日志文件

**验收标准**

- 配置项完整
- 配置修改实时生效
- 操作日志完整准确
- 日志可追溯

---

## 3. 非功能性需求

### 3.1 性能需求

| 指标 | 目标值 |
|------|--------|
| 单文件导入时间 | < 30s（1000 条记录）|
| 基础查询响应时间 | < 500ms |
| 模糊搜索响应时间 | < 1s |
| 图谱渲染时间 | < 2s（500 个节点）|
| 数据导出时间 | < 10s（1000 条记录）|
| API 并发支持 | 100 QPS |

### 3.2 可用性需求

- 系统可用性 ≥ 99%
- 数据不丢失（定期备份）
- 支持数据恢复
- 错误提示清晰明确

### 3.3 安全需求

- 传输加密（HTTPS）
- 数据存储加密（可选）
- 认证与权限（后续版本）
- 操作日志完整

### 3.4 兼容性需求

- 支持主流浏览器（Chrome、Firefox、Safari、Edge）
- 支持桌面端和平板端
- 响应式设计

### 3.5 可维护性需求

- 代码结构清晰
- 文档完整
- 日志详细
- 易于部署和升级

---

## 4. 数据模型

### 4.1 核心实体

基于技术架构文档中定义的 8 类节点：

1. **Organization（组织）**
   - 业务标识：external_id
   - 核心字段：name, full_name, credit_code
   - 元数据：JSONB

2. **Netblock（网段）**
   - 业务标识：external_id
   - 核心字段：cidr, asn_number
   - 元数据：JSONB

3. **Domain（域名）**
   - 业务标识：external_id
   - 核心字段：name, root_domain
   - 元数据：JSONB

4. **IP（主机）**
   - 业务标识：external_id
   - 核心字段：address, version
   - 元数据：JSONB

5. **Certificate（证书）**
   - 业务标识：external_id（cert:SHA256）
   - 核心字段：subject_cn, issuer_cn, valid_from, valid_to
   - 元数据：JSONB

6. **Service（服务）**
   - 业务标识：external_id（svc:IP:Port[:UDP]）
   - 核心字段：port, protocol, service_name, product, version
   - 元数据：JSONB

7. **ClientApplication（客户端应用）**
   - 业务标识：external_id
   - 核心字段：name, bundle_id, platform
   - 元数据：JSONB

8. **Credential（凭证）**
   - 业务标识：external_id
   - 核心字段：type, provider, is_valid
   - 元数据：JSONB

### 4.2 关系类型

基于技术架构文档中定义的 13 种边关系：

**归属类**
- SUBSIDIARY（子公司）
- OWNS_NETBLOCK（拥有网段）
- OWNS_ASSET（拥有资产）
- OWNS_DOMAIN（拥有域名）

**拓扑类**
- CONTAINS（包含）
- SUBDOMAIN（子域名）

**解析类**
- RESOLVES_TO（当前解析）
- HISTORY_RESOLVES_TO（历史解析）
- ISSUED_TO（证书签发）

**服务与路由类**
- HOSTS_SERVICE（物理承载）
- ROUTES_TO（逻辑路由）
- UPSTREAM（上游代理）
- COMMUNICATES（客户端通信）

---

## 5. 用户界面设计

### 5.1 页面结构

```
┌─────────────────────────────────────────────────────────┐
│                      顶部导航栏                          │
│  Logo | 数据导入 | 资产管理 | 图谱 | 报表 | 配置        │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│                                                          │
│                      主内容区                            │
│                                                          │
│                                                          │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 5.2 核心页面

1. **数据导入页面**
   - 文件上传区域（拖拽上传）
   - 导入历史列表
   - 导入进度显示
   - 错误日志查看

2. **资产管理页面**
   - 资产列表（表格）
   - 搜索和筛选
   - 批量操作
   - 资产详情（侧边栏）

3. **图谱页面**
   - 图谱画布（主区域）
   - 控制面板（左侧）
   - 节点详情（右侧）
   - 工具栏（顶部）

4. **报表页面**
   - 统计图表
   - 报表模板
   - 导出配置
   - 历史报表

5. **配置页面**
   - 系统配置
   - 数据源配置
   - 显示配置
   - 操作日志

---

## 6. 实施优先级

### 6.1 第一阶段（MVP）

**目标**：实现核心功能，支持基本的数据导入和查询

**功能清单**
- ✅ 数据导入（Nmap XML、通用 JSON）
- ✅ 基础查询（IP、域名、端口）
- ✅ 资产列表展示
- ✅ 简单的图谱可视化
- ✅ CSV 导出

**时间**：4-6 周

### 6.2 第二阶段（增强）

**目标**：完善功能，提升用户体验

**功能清单**
- ✅ 更多数据格式支持（Masscan、Nuclei）
- ✅ 高级查询和过滤
- ✅ 交互式图谱
- ✅ 去重和合并
- ✅ 报表生成

**时间**：4-6 周

### 6.3 第三阶段（优化）

**目标**：性能优化和功能完善

**功能清单**
- ✅ 性能优化（缓存、索引）
- ✅ 批量操作
- ✅ 更多导出格式
- ✅ 配置管理
- ✅ 操作日志

**时间**：2-4 周

---

## 7. 验收标准

### 7.1 功能验收

- 所有 P0 功能完整实现
- 所有 P1 功能至少实现 80%
- 核心用例全部通过测试

### 7.2 性能验收

- 满足性能需求指标
- 压力测试通过（100 并发用户）
- 无明显性能瓶颈

### 7.3 质量验收

- 代码覆盖率 > 70%
- 无严重 Bug
- 用户体验良好

---

## 8. 总结

ExternalHound v1.0 功能需求文档定义了一个**简洁而强大**的渗透测试数据管理平台：

**核心特性**
1. **多源数据导入**：支持主流扫描工具的结果导入
2. **智能数据管理**：自动去重、合并、归一化
3. **强大的查询能力**：多维度查询、模糊搜索、关系查询
4. **直观的图谱可视化**：交互式探索资产关系
5. **专业的报表导出**：多格式、可定制

**设计原则**
- **简单优先**：去除不必要的复杂功能
- **专注核心**：聚焦数据管理和可视化
- **易于使用**：直观的用户界面
- **易于扩展**：模块化设计，便于添加新功能

该系统能够有效支撑渗透测试团队的资产管理需求，提高工作效率，降低管理成本。
